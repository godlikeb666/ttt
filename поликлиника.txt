USE mydb;

CREATE TABLE patients (
    patient_id INT AUTO_INCREMENT PRIMARY KEY,
    last_name VARCHAR(50),
    first_name VARCHAR(50),
    middle_name VARCHAR(50),
    birth_date DATE,
    social_status VARCHAR(50),
    current_state VARCHAR(50)
);

CREATE TABLE doctors (
    doctor_id INT AUTO_INCREMENT PRIMARY KEY,
    fio VARCHAR(100) NOT NULL,
    position VARCHAR(100),
    qualification VARCHAR(50),
    specialization VARCHAR(100)
);

CREATE TABLE treatments (
    treatment_id INT AUTO_INCREMENT PRIMARY KEY,
    patient_id INT,
    doctor_id INT,
    diagnosis VARCHAR(100),
    is_ambulatory BOOLEAN,
    sick_leave_days INT,
    is_dispensary BOOLEAN,
    start_date DATE,
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id)
);

INSERT INTO patients (last_name, first_name, social_status, current_state) VALUES 
('Иванов', 'Иван', 'Пенсионер', 'Вылечился'),
('Петров', 'Петр', 'Учащийся', 'Умер'),
('Сидоров', 'Сидор', 'Работающий', 'Лечится');

INSERT INTO doctors (fio, qualification, specialization) VALUES 
('Доктор А.А.', '1-я', 'Невропатолог'),
('Доктор Б.Б.', '2-я', 'Терапевт'),
('Доктор В.В.', '1-я', 'Стоматолог');

INSERT INTO treatments (patient_id, doctor_id, diagnosis, start_date) VALUES 
(1, 1, 'Язва желудка', '2025-01-01'), 
(1, 2, 'Кариес', '2025-02-01'),       
(2, 3, 'Кариес', '2025-03-01'),       
(3, 2, 'Грипп', '2025-04-01'),
(1, 3, 'Грипп', '2025-05-01');  




Выборки: 
•	Определить те случаи, когда заболевание «язва желудка» лечилось врачом специализации «невропатолог». 
SELECT t.treatment_id, d.fio, p.last_name, t.diagnosis
FROM treatments t, doctors d, patients p
WHERE t.doctor_id = d.doctor_id AND t.patient_id = p.patient_id
  AND t.diagnosis = 'Язва желудка'
  AND d.specialization = 'Невропатолог';
•	Вывести имена тех врачей, которые работают исключительно с пенсионерами. 
SELECT d.fio
FROM doctors d
WHERE d.doctor_id NOT IN (
    SELECT DISTINCT t.doctor_id
    FROM treatments t, patients p
    WHERE t.patient_id = p.patient_id
      AND p.social_status <> 'Пенсионер'
) AND d.doctor_id IN (SELECT doctor_id FROM treatments);
•	Определить процент смертности от заболевания «кариес». 
SELECT 
    SUM(CASE WHEN p.current_state = 'Умер' THEN 1 ELSE 0 END) * 100.0 / COUNT(*) AS mortality_percent
FROM treatments t, patients p
WHERE t.patient_id = p.patient_id
  AND t.diagnosis = 'Кариес';
•	Пациентов, которые болеют (болели) всеми болезнями. 
SELECT p.last_name
FROM patients p, treatments t
WHERE p.patient_id = t.patient_id
GROUP BY p.patient_id
HAVING COUNT(DISTINCT t.diagnosis) = (SELECT COUNT(DISTINCT diagnosis) FROM treatments);
